<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <meta name="apple-mobile-web-app-title" content="Torneo">

  <title>Torneo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

  <style>
    :root {
      --neon-green: #39ff14;
      --dark-bg: #050505;
      --panel-bg: #111111;
      --border-color: #333;
      --glow: none;
      --danger: #ff003c;
      --active-bg: rgba(57, 255, 20, 0.2);
    }

    body {
      font-family: 'Anton', sans-serif;
      background-color: var(--dark-bg);
      color: var(--neon-green);
      margin: 0;
      /* AGGIORNATO: Padding per evitare che la barra di stato iPhone copra il titolo */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 1px;
    }

    .app-container {
      width: 100%;
      max-width: 600px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* HEADER */
    header {
      background: #000;
      border-bottom: 2px solid var(--neon-green);
      padding: 15px;
      padding-top: 20px; /* Un po' piÃ¹ spazio sopra */
      text-align: center;
      font-size: 1.6rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* PROGRESS BAR */
    .progress-container {
      background: #222;
      height: 6px;
      width: 100%;
    }

    .progress-bar {
      height: 100%;
      background: var(--neon-green);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* STEPS */
    .step-page {
      display: none;
      padding: 20px;
      flex-grow: 1;
      animation: fadeIn 0.5s ease;
      padding-bottom: 80px; /* Spazio per il bottone in basso */
    }

    .step-page.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* UI ELEMENTS */
    h2 {
      color: white;
      margin-top: 0;
      border-bottom: 2px solid var(--neon-green);
      padding-bottom: 10px;
      display: inline-block;
      font-size: 1.5rem;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin-top: 25px;
      color: #888;
      text-transform: uppercase;
      font-size: 1rem;
    }

    textarea, input, select {
      width: 100%;
      padding: 15px;
      margin-top: 5px;
      background: #000;
      border: 2px solid var(--neon-green);
      color: var(--neon-green);
      border-radius: 0;
      box-sizing: border-box;
      font-size: 18px;
      font-family: 'Anton', sans-serif;
      letter-spacing: 1px;
      -webkit-appearance: none; /* Rimuove stile default iOS */
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: white;
      background: #0a0a0a;
    }

    .time-inputs {
      display: flex;
      gap: 10px;
    }

    .time-inputs div {
      flex: 1;
    }

    /* BUTTONS */
    .btn-action {
      width: 100%;
      padding: 20px;
      background-color: #000;
      color: var(--neon-green);
      border: 3px solid var(--neon-green);
      font-size: 22px;
      text-transform: uppercase;
      cursor: pointer;
      position: sticky;
      bottom: 0;
      transition: 0.1s;
      letter-spacing: 2px;
      z-index: 100;
      font-family: 'Anton', sans-serif;
      /* Fix per iPhone X e successivi */
      padding-bottom: max(20px, env(safe-area-inset-bottom)); 
    }

    .btn-action:hover {
      background-color: var(--neon-green);
      color: black;
    }

    .btn-red {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-red:hover {
      background-color: var(--danger);
      color: white;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 12px;
      background: transparent;
      border: 2px solid var(--danger);
      color: var(--danger);
      cursor: pointer;
      text-transform: uppercase;
      font-family: 'Anton', sans-serif;
      letter-spacing: 1px;
    }

    /* CARDS MATCH */
    .match-card {
      background: #0a0a0a;
      border: 2px solid #333;
      border-left: 6px solid var(--neon-green);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }

    .vs-badge {
      background: var(--neon-green);
      color: black;
      padding: 5px 10px;
      font-size: 1.1rem;
      margin: 15px 0;
      display: inline-block;
    }

    /* TIMER */
    #timerDisplay {
      font-size: 6rem;
      text-align: center;
      margin: 40px 0;
      color: var(--neon-green);
    }

    .pulse {
      animation: pulse-opacity 0.8s infinite;
      color: var(--danger) !important;
    }

    @keyframes pulse-opacity {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }

    /* SELEZIONE PUNTEGGIO (PULSANTI) */
    .score-match-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 15px;
      border-bottom: 2px solid #222;
      padding-bottom: 15px;
    }

    .team-select-btn {
      flex: 1;
      padding: 25px 10px;
      background: #000;
      border: 3px solid #444;
      color: #666;
      cursor: pointer;
      text-transform: uppercase;
      font-family: 'Anton', sans-serif;
      font-size: 1.1rem;
      transition: all 0.1s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }

    .team-select-btn small {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 5px;
    }

    .team-select-btn.selected {
      border-color: var(--neon-green);
      background: var(--active-bg);
      color: white;
    }

    .match-result-status {
      text-align: center;
      font-size: 1rem;
      margin-top: -10px;
      margin-bottom: 30px;
      color: #888;
    }

    .status-win { color: var(--neon-green); }
    .status-draw { color: white; }
    .status-none { color: var(--danger); }

    /* CLASSIFICA */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border: 2px solid #333;
    }

    th {
      background: #222;
      color: white;
      padding: 15px;
      text-align: left;
      text-transform: uppercase;
      font-size: 1rem;
      letter-spacing: 1px;
    }

    td {
      padding: 15px;
      border-bottom: 2px solid #333;
      color: #ddd;
      font-size: 1.1rem;
    }

    tr:nth-child(1) td {
      color: var(--neon-green);
      font-size: 1.3em;
    }
  </style>
</head>

<body>

  <audio id="audioFischio" src="https://actions.google.com/sounds/v1/sports/referee_whistle.ogg" preload="auto"></audio>

  <div class="app-container">

    <header>
      <span>Torneo</span>
      <button class="btn-small" onclick="resetApp()">RESET</button>
    </header>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="step-1" class="step-page active">
      <h2>IMPOSTAZIONI</h2>

      <label>INSERISCI GIOCATORI</label>
      <textarea id="playerInput" rows="5" placeholder="Enea, Matteo, Luca, ..."></textarea>

      <label>INSERISCI UNITA (Giocatori per squadra)</label>
      <input type="number" id="teamSize" value="2">

      <label>Tempo Operazione</label>
      <div class="time-inputs">
        <input type="number" id="timeMin" placeholder="MIN" value="5">
        <input type="number" id="timeSec" placeholder="SEC" value="00">
      </div>

      <div style="flex-grow:1"></div>
      <button class="btn-action" onclick="goToStep2_Genera()">[ GENERARE SQUADRE ]</button>
    </div>

    <div id="step-2" class="step-page">
      <h2>2. TABELLONE SFIDE</h2>
      <p style="color:#666; font-size:1rem; text-transform:uppercase;">SQUADRE GENERATE</p>

      <div id="matchupsContainer"></div>

      <div style="flex-grow:1"></div>
      <button class="btn-action" onclick="goToStep3_Timer()">[ AVVIA PARTITA ]</button>
    </div>

    <div id="step-3" class="step-page">
      <h2>3. ARENA LIVE</h2>
      <div style="text-align:center; margin-top:20px; color:#555; text-transform:uppercase; font-size: 1.2rem;">MATCH IN CORSO</div>

      <div id="timerDisplay">00:00</div>

      <div style="text-align:center;">
        <button class="btn-small" style="font-size:14px; padding:10px 20px; border-color:white; color:white;" onclick="togglePause()">|| Pausa / Riprendi</button>
      </div>

      <div style="flex-grow:1"></div>
      <button id="btnEndMatch" class="btn-action btn-red" onclick="goToStep4_Risultati()" disabled>ATTENDI FINE TEMPO</button>
    </div>

    <div id="step-4" class="step-page">
      <h2>4. REPORT ESITI</h2>
      <p style="color:#666; font-size:1rem; text-transform:uppercase;">TOCCA LA SQUADRA VINCENTE.<br>TOCCA ENTRAMBE PER IL PAREGGIO.</p>

      <div id="scoresContainer" style="margin-top: 30px;"></div>

      <div style="flex-grow:1"></div>
      <button class="btn-action" onclick="goToStep5_Classifica()">[ SALVA DATI ]</button>
    </div>

    <div id="step-5" class="step-page">
      <h2>5. CLASSIFICA GLOBALE</h2>

      <div style="overflow-y: auto; max-height: 60vh; border: 2px solid #333;">
        <table id="rankingTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Giocatore</th>
              <th>Punteggio</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="flex-grow:1"></div>
      <button class="btn-action" onclick="nuovaPartitaLoop()">[ Prossima Partita ]</button>
    </div>

  </div>

  <script>
    // --- DATI ---
    let playersDB = {};
    let currentTeams = [];
    let matchTimeSeconds = 0;
    let timerInterval = null;
    let isPaused = false;
    // --- NAVIGAZIONE STEPS ---
    function showStep(stepNumber) {
      document.querySelectorAll('.step-page').forEach(el => el.classList.remove('active'));
      document.getElementById(`step-${stepNumber}`).classList.add('active');
      document.getElementById('progressBar').style.width = (stepNumber * 20) + "%";
    }
    // --- STEP 1 -> 2: LOGICA GENERAZIONE SQUADRE ---
    function goToStep2_Genera() {
      const input = document.getElementById('playerInput').value;
      const size = parseInt(document.getElementById('teamSize').value);
      let names = input.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
      if (names.length < 2) {
        alert("ERRORE: Inserisci almeno 2 giocatori.");
        return;
      }
      names.forEach(n => {
        if (!playersDB.hasOwnProperty(n)) playersDB[n] = 0;
      });
      names = names.sort(() => Math.random() - 0.5);
      currentTeams = [];
      for (let i = 0; i < names.length; i += size) {
        currentTeams.push(names.slice(i, i + size));
      }
      // UNISCI GIOCATORE RIMASTO SOLO
      if (currentTeams.length > 1) {
        const lastTeamIndex = currentTeams.length - 1;
        if (currentTeams[lastTeamIndex].length === 1) {
          const lonePlayer = currentTeams[lastTeamIndex][0];
          currentTeams.pop();
          currentTeams[currentTeams.length - 1].push(lonePlayer);
        }
      }
      renderMatchups();
      showStep(2);
    }

    function renderMatchups() {
      const div = document.getElementById('matchupsContainer');
      div.innerHTML = '';
      for (let i = 0; i < currentTeams.length; i += 2) {
        const t1 = currentTeams[i];
        const t2 = currentTeams[i + 1];
        const card = document.createElement('div');
        card.className = 'match-card';
        if (t2) {
          card.innerHTML = `
                    <div style="color:white; font-size:1.3em;">${t1.join(' + ')}</div>
                    <span class="vs-badge">VS</span>
                    <div style="color:var(--danger); font-size:1.3em;">${t2.join(' + ')}</div>
                `;
        } else {
          card.innerHTML = `
                    <div style="color:#888; font-size:1.2em;">${t1.join(' + ')}</div>
                    <span class="vs-badge" style="background:#444; color:#aaa">IN ATTESA (RIPOSO)</span>
                `;
        }
        div.appendChild(card);
      }
    }
    // --- STEP 2 -> 3: TIMER ---
    function goToStep3_Timer() {
      const min = parseInt(document.getElementById('timeMin').value) || 0;
      const sec = parseInt(document.getElementById('timeSec').value) || 0;
      matchTimeSeconds = (min * 60) + sec;
      if (matchTimeSeconds === 0) matchTimeSeconds = 300;
      renderTimer(matchTimeSeconds);
      document.getElementById('timerDisplay').classList.remove('pulse');
      document.getElementById('btnEndMatch').disabled = true;
      document.getElementById('btnEndMatch').innerText = "PARTITA IN CORSO...";
      document.getElementById('btnEndMatch').style.opacity = "0.5";
      document.getElementById('btnEndMatch').classList.remove('btn-red');
      suonaFischio();
      startTimer();
      showStep(3);
    }

    function startTimer() {
      clearInterval(timerInterval);
      isPaused = false;
      timerInterval = setInterval(() => {
        if (!isPaused) {
          matchTimeSeconds--;
          renderTimer(matchTimeSeconds);
          if (matchTimeSeconds <= 10) document.getElementById('timerDisplay').classList.add('pulse');
          if (matchTimeSeconds <= 0) {
            clearInterval(timerInterval);
            suonaFischio();
            timerEndedUI();
          }
        }
      }, 1000);
    }

    function togglePause() {
      isPaused = !isPaused;
    }

    function timerEndedUI() {
      document.getElementById('timerDisplay').innerText = "00:00";
      const btn = document.getElementById('btnEndMatch');
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.classList.add('btn-red');
      btn.innerText = "FISCHIO FINALE [ VAI AI RISULTATI ]";
    }

    function renderTimer(s) {
      const m = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      document.getElementById('timerDisplay').innerText = `${m}:${sec}`;
    }
    // --- STEP 3 -> 4: INTERFACCIA RISULTATI (PULSANTI) ---
    function goToStep4_Risultati() {
      const div = document.getElementById('scoresContainer');
      div.innerHTML = '';
      for (let i = 0; i < currentTeams.length; i += 2) {
        const t1 = currentTeams[i];
        const t2 = currentTeams[i + 1];
        const matchId = i;
        if (t2) {
          const container = document.createElement('div');
          // Nomi formattati per i pulsanti
          const name1 = t1.length > 2 ? `TEAM A<br><small>${t1[0]}...</small>` : t1.join('<br>');
          const name2 = t2.length > 2 ? `TEAM B<br><small>${t2[0]}...</small>` : t2.join('<br>');
          container.innerHTML = `
                    <div style="text-align:center; font-size:1rem; color:#666; margin-bottom:10px;">MATCH ${i/2 + 1}</div>
                    
                    <div class="score-match-container">
                        <button class="team-select-btn" id="btn-m${matchId}-t0" onclick="toggleSelection(${matchId}, 0)">
                            ${name1}
                        </button>
                        
                        <div style="font-size: 1.5rem; color:#444;">VS</div>
                        
                        <button class="team-select-btn" id="btn-m${matchId}-t1" onclick="toggleSelection(${matchId}, 1)">
                            ${name2}
                        </button>
                    </div>
                    
                    <div id="status-m${matchId}" class="match-result-status status-none">SELEZIONA ESITO</div>
                `;
          div.appendChild(container);
        }
      }
      showStep(4);
    }

    function toggleSelection(matchId, teamIndex) {
      const btn = document.getElementById(`btn-m${matchId}-t${teamIndex}`);
      btn.classList.toggle('selected');
      updateMatchStatus(matchId);
    }

    function updateMatchStatus(matchId) {
      const btn0 = document.getElementById(`btn-m${matchId}-t0`);
      const btn1 = document.getElementById(`btn-m${matchId}-t1`);
      const statusDiv = document.getElementById(`status-m${matchId}`);
      const sel0 = btn0.classList.contains('selected');
      const sel1 = btn1.classList.contains('selected');
      if (sel0 && sel1) {
        statusDiv.innerText = "PAREGGIO (2 Punti)";
        statusDiv.className = "match-result-status status-draw";
      } else if (sel0) {
        statusDiv.innerText = "VINCITORE: SQUADRA SX (3 Punti)";
        statusDiv.className = "match-result-status status-win";
      } else if (sel1) {
        statusDiv.innerText = "VINCITORE: SQUADRA DX (3 Punti)";
        statusDiv.className = "match-result-status status-win";
      } else {
        statusDiv.innerText = "SELEZIONA ESITO";
        statusDiv.className = "match-result-status status-none";
      }
    }
    // --- STEP 4 -> 5: CALCOLO PUNTI ---
    function goToStep5_Classifica() {
      for (let i = 0; i < currentTeams.length; i += 2) {
        const t1 = currentTeams[i];
        const t2 = currentTeams[i + 1];
        if (t2) {
          const btn0 = document.getElementById(`btn-m${i}-t0`);
          const btn1 = document.getElementById(`btn-m${i}-t1`);
          const win0 = btn0.classList.contains('selected');
          const win1 = btn1.classList.contains('selected');
          let pts0 = 0;
          let pts1 = 0;
          if (win0 && win1) {
            pts0 = 2;
            pts1 = 2;
          } else if (win0) {
            pts0 = 3;
            pts1 = 1;
          } else if (win1) {
            pts0 = 1;
            pts1 = 3;
          }
          t1.forEach(p => playersDB[p] += pts0);
          t2.forEach(p => playersDB[p] += pts1);
        }
      }
      renderRanking();
      showStep(5);
    }

    function renderRanking() {
      const tbody = document.querySelector('#rankingTable tbody');
      tbody.innerHTML = '';
      const sorted = Object.keys(playersDB)
        .map(name => ({
          n: name,
          p: playersDB[name]
        }))
        .sort((a, b) => b.p - a.p);
      sorted.forEach((item, idx) => {
        const tr = document.createElement('tr');
        let medal = "";
        if (idx === 0) medal = "ðŸ¥‡";
        if (idx === 1) medal = "ðŸ¥ˆ";
        if (idx === 2) medal = "ðŸ¥‰";
        tr.innerHTML = `<td>${idx+1} ${medal}</td><td>${item.n}</td><td>${item.p}</td>`;
        tbody.appendChild(tr);
      });
    }

    function nuovaPartitaLoop() {
      goToStep2_Genera();
    }

    function suonaFischio() {
      const audio = document.getElementById('audioFischio');
      audio.currentTime = 0;
      audio.play().catch(e => console.warn("Audio bloccato"));
    }
    // --- NUOVA FUNZIONE RESET MANUALE ---
    function resetApp() {
      if (confirm("Vuoi azzerare il torneo e tornare all'inizio?")) {
        // 1. Reset variabili
        playersDB = {};
        currentTeams = [];
        matchTimeSeconds = 0;
        clearInterval(timerInterval);
        isPaused = false;
        // 2. Pulisci Contenitori
        document.getElementById('matchupsContainer').innerHTML = '';
        document.getElementById('scoresContainer').innerHTML = '';
        document.querySelector('#rankingTable tbody').innerHTML = '';
        // 3. Reset Timer UI
        document.getElementById('timerDisplay').innerText = "00:00";
        document.getElementById('timerDisplay').classList.remove('pulse');
        const btnEnd = document.getElementById('btnEndMatch');
        btnEnd.disabled = true;
        btnEnd.innerText = "ATTENDI FINE TEMPO";
        btnEnd.classList.remove('btn-red');
        btnEnd.style.opacity = "0.5";
        // 4. Torna alla pagina 1
        showStep(1);
      }
    }
  </script>

</body>

</html>
