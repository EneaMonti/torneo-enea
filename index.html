<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Torneo Enea</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --neon-green: #39ff14;
      --dark-bg: #050505;
      --panel-bg: #111111;
      --border-color: #333;
      --danger: #ff003c;
      --active-bg: rgba(57, 255, 20, 0.2);
      --blue: #2196F3;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--dark-bg);
      color: var(--neon-green);
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    h1, h2, h3, .anton-font { font-family: 'Anton', sans-serif; letter-spacing: 1px; }

    .app-container {
      width: 100%;
      max-width: 600px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* HEADER */
    header {
      background: #000;
      border-bottom: 2px solid var(--neon-green);
      padding: 15px;
      padding-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo { font-size: 1.5rem; text-transform: uppercase; color: white; }

    /* PROGRESS BAR */
    .progress-container { background: #222; height: 4px; width: 100%; }
    .progress-bar { height: 100%; background: var(--neon-green); width: 0%; transition: width 0.3s ease; }

    /* PAGES */
    .step-page {
      display: none;
      padding: 20px;
      flex-grow: 1;
      flex-direction: column;
      animation: fadeIn 0.4s ease;
      padding-bottom: 100px; /* Spazio per bottone sticky */
    }

    .step-page.active { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* FORMS */
    label { display: block; margin-top: 20px; color: #888; text-transform: uppercase; font-size: 0.9rem; font-weight: bold; }
    
    textarea, input, select {
      width: 100%;
      padding: 15px;
      margin-top: 8px;
      background: #000;
      border: 1px solid #444;
      color: white;
      font-size: 1.1rem;
      font-family: 'Roboto', sans-serif;
      border-radius: 4px;
    }

    /* UPPERCASE VISIVO */
    textarea#playerInput {
        text-transform: uppercase;
    }
    
    textarea:focus, input:focus { outline: none; border-color: var(--neon-green); }

    .time-inputs { display: flex; gap: 10px; }
    .time-inputs div { flex: 1; }

    /* COUNTER & WARNING */
    .input-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }
    .player-counter {
        color: var(--neon-green);
        font-size: 0.9rem;
        font-weight: bold;
    }
    .warning-box {
        display: none;
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid var(--danger);
        color: var(--danger);
        padding: 10px;
        margin-top: 10px;
        font-size: 0.9rem;
        border-radius: 4px;
        animation: pulse-border 1.5s infinite;
    }
    @keyframes pulse-border {
        0% { border-color: var(--danger); }
        50% { border-color: transparent; }
        100% { border-color: var(--danger); }
    }

    /* BUTTONS */
    .btn-action {
      width: 100%;
      padding: 20px;
      background-color: var(--neon-green);
      color: black;
      border: none;
      font-size: 1.4rem;
      text-transform: uppercase;
      font-family: 'Anton', sans-serif;
      cursor: pointer;
      position: sticky;
      bottom: 0;
      margin-top: auto; 
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
      transition: all 0.2s;
    }

    .btn-action:active { filter: brightness(0.8); }
    .btn-action:disabled { background-color: #333; color: #666; cursor: not-allowed; }

    .btn-red { background-color: var(--danger); color: white; }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
      border-radius: 4px;
      text-transform: uppercase;
      cursor: pointer;
    }
    
    .btn-blue {
        border-color: var(--blue);
        color: var(--blue);
    }

    /* MATCH CARDS */
    .match-card {
      background: #1a1a1a;
      border-left: 4px solid var(--neon-green);
      padding: 15px;
      margin-bottom: 10px;
      text-align: center;
      border-radius: 0 4px 4px 0;
    }
    
    .vs-badge { 
      background: #333; color: var(--neon-green); 
      padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin: 5px 0; display: inline-block;
    }

    /* TIMER */
    #timerDisplay {
      font-size: 6rem;
      text-align: center;
      margin: 30px 0;
      font-family: 'Anton', sans-serif;
      color: white;
      text-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
    }
    
    .timer-paused { color: #555 !important; text-shadow: none !important; }
    .pulse { animation: pulse-red 1s infinite; color: var(--danger) !important; }

    @keyframes pulse-red {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* SCORE SELECTION */
    .score-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 20px;
    }

    .team-btn {
      flex: 1;
      background: #1a1a1a;
      border: 2px solid #333;
      color: #aaa;
      padding: 15px 5px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }

    .team-btn.selected {
      border-color: var(--neon-green);
      background: var(--active-bg);
      color: white;
    }
    
    .team-names { font-size: 0.9rem; font-weight: bold; line-height: 1.4; }
    .result-label { margin-top: 5px; font-size: 0.7rem; text-transform: uppercase; }

    /* RANKING TABLE */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; color: #666; padding: 10px; border-bottom: 1px solid #333; font-size: 0.8rem; text-transform: uppercase;}
    td { padding: 12px 5px; border-bottom: 1px solid #222; font-size: 1.1rem; color: white;}
    tr:first-child td { color: var(--neon-green); font-size: 1.3rem; font-weight: bold; }
    
    .manual-score-container {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
    }

    .btn-adj {
        background: #222;
        border: 1px solid #444;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    .btn-adj:active { background: #444; }
    .btn-adj.minus { color: var(--danger); border-color: var(--danger); }
    .btn-adj.plus { color: var(--neon-green); border-color: var(--neon-green); }

    /* MODAL LIVE RANKING */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 20px;
    }
    
    .modal-overlay.active-modal { display: flex; }

    .modal-content {
        background: #111;
        border: 2px solid var(--neon-green);
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
    }

    .close-modal-btn {
        margin-top: 20px;
        padding: 15px 40px;
        background: white;
        color: black;
        border: none;
        font-weight: bold;
        text-transform: uppercase;
        font-family: 'Anton', sans-serif;
        font-size: 1.2rem;
        cursor: pointer;
    }

  </style>
</head>
<body>

<audio id="whistleSound" src="https://actions.google.com/sounds/v1/sports/referee_whistle.ogg" preload="auto"></audio>

<div id="liveRankingModal" class="modal-overlay">
    <h2 class="anton-font" style="color: white; margin-bottom: 10px;">CLASSIFICA PARZIALE</h2>
    <div class="modal-content">
        <table id="liveRankingTable">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Giocatore</th>
                    <th style="text-align:right">Punti</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <button class="close-modal-btn" onclick="hideLiveRanking()">CHIUDI X</button>
</div>

<div class="app-container">
  
  <header>
    <div class="logo anton-font">TORNEO<span style="color:var(--neon-green)">.ENEA</span></div>
    <button class="btn-small" onclick="fullReset()">RESET TOTALE</button>
  </header>
  
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

  <div id="step-1" class="step-page active">
    <h2 class="anton-font" style="color:white; border-bottom:2px solid var(--neon-green); display:inline-block;">CONFIGURAZIONE</h2>
    
    <div class="input-header">
        <label style="margin-top:0">Lista Giocatori</label>
        <span class="player-counter">TOTALE: <span id="playerCountVal">0</span></span>
    </div>
    
    <textarea id="playerInput" rows="6" placeholder="ES: MARCO, LUCA..." oninput="checkInputChanges()"></textarea>
    
    <div id="duplicateAlert" class="warning-box"></div>
    
    <label>Giocatori per Squadra</label>
    <input type="number" id="teamSize" value="2" min="1">
    
    <label>Durata Partita</label>
    <div class="time-inputs">
      <div>
        <input type="number" id="timeMin" value="5" placeholder="Min">
      </div>
      <div>
        <input type="number" id="timeSec" value="00" placeholder="Sec">
      </div>
    </div>

    <button id="btnGenerate" class="btn-action" onclick="generateTeams()">CREA SQUADRE</button>
  </div>

  <div id="step-2" class="step-page">
    <h2 class="anton-font" style="color:white;">PROSSIME SFIDE</h2>
    <div id="matchesList"></div>
    <button class="btn-action" onclick="startMatch()">AVVIA PARTITA</button>
  </div>

  <div id="step-3" class="step-page">
    <h2 class="anton-font" style="text-align:center; color:#666;">MATCH IN CORSO</h2>
    
    <div id="timerDisplay">00:00</div>
    
    <div style="text-align:center; margin-bottom: 20px; display:flex; justify-content:center; gap:10px;">
      <button class="btn-small" style="padding: 10px 20px; font-size:1rem; border-color: #666; color: #ccc;" onclick="togglePause()">
        <span id="pauseBtnLabel">PAUSA ||</span>
      </button>

      <button class="btn-small btn-blue" style="padding: 10px 20px; font-size:1rem;" onclick="showLiveRanking()">
        üèÜ CLASSIFICA LIVE
      </button>
    </div>

    <div style="flex-grow:1"></div> <button id="btnEndMatch" class="btn-action btn-red" onclick="tryFinishMatch()">FISCHIO FINALE (CHIUDI ORA)</button>
  </div>

  <div id="step-4" class="step-page">
    <h2 class="anton-font" style="color:white;">CHI HA VINTO?</h2>
    <p style="color:#666; font-size:0.9rem;">Tocca la squadra vincente. Tocca entrambe per pareggio.</p>
    
    <div id="scoringList" style="margin-top:20px;"></div>
    
    <button class="btn-action" onclick="saveScores()">SALVA E CLASSIFICA</button>
  </div>

  <div id="step-5" class="step-page">
    <h2 class="anton-font" style="color:white;">CLASSIFICA</h2>
    <p style="color:#666; font-size:0.8rem; margin-bottom:10px;">Usa i tasti + e - per correggere i punti manualmente.</p>
    
    <div style="overflow-y:auto; border: 1px solid #333; border-radius: 4px;">
      <table id="rankingTable">
        <thead>
          <tr>
            <th width="15%">#</th>
            <th>Giocatore</th>
            <th width="35%" style="text-align:right">PT</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <button class="btn-action" onclick="nextRound()">PROSSIMO TURNO</button>
  </div>

</div>

<script>
  // --- STATO DELL'APP ---
  let playersDB = {}; // { "Nome": punti }
  let currentTeams = []; // [[p1, p2], [p3, p4]...]
  let previousTeamsSignature = ""; // Stringa per ricordare l'ultimo turno
  
  // Variabili Timer
  let timerInterval = null;
  let endTime = null;     
  let remainingMs = 0;    
  let isPaused = false;
  let totalMatchMs = 0;   
  let wakeLock = null;    
  let isMatchRunning = false; 

  // --- LOGICA DI NAVIGAZIONE ---
  function showStep(n) {
    document.querySelectorAll('.step-page').forEach(el => el.classList.remove('active'));
    document.getElementById(`step-${n}`).classList.add('active');
    document.getElementById('progressBar').style.width = (n * 20) + "%";
  }

  // --- NUOVA FUNZIONE: CONTROLLO INPUT REAL-TIME ---
  function checkInputChanges() {
      const raw = document.getElementById('playerInput').value.toUpperCase();
      // Estrai nomi puliti
      const names = raw.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
      
      // 1. Aggiorna contatore
      document.getElementById('playerCountVal').innerText = names.length;

      // 2. Controllo duplicati
      const seen = new Set();
      const duplicates = new Set();
      names.forEach(n => {
          if (seen.has(n)) duplicates.add(n);
          seen.add(n);
      });

      const alertBox = document.getElementById('duplicateAlert');
      const genBtn = document.getElementById('btnGenerate');

      if (duplicates.size > 0) {
          // Trovati duplicati
          const dupList = Array.from(duplicates).join(", ");
          alertBox.style.display = "block";
          alertBox.innerHTML = `‚ö†Ô∏è <b>ATTENZIONE:</b> "${dupList}" √® inserito pi√π volte.<br>Aggiungi il cognome per distinguerli!`;
          genBtn.disabled = true; // Blocca il pulsante
          genBtn.innerText = "CORREGGI I NOMI";
      } else {
          // Tutto ok
          alertBox.style.display = "none";
          genBtn.disabled = false;
          genBtn.innerText = "CREA SQUADRE";
      }
  }

  // --- STEP 1 -> 2: GENERAZIONE SQUADRE ---
  function generateTeams() {
    const rawNames = document.getElementById('playerInput').value.toUpperCase();
    const size = parseInt(document.getElementById('teamSize').value);
    
    let baseNames = rawNames.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
    
    if (baseNames.length < 2) {
      alert("Inserisci almeno 2 giocatori!");
      return;
    }

    // Controllo sicurezza finale sui duplicati
    const uniqueCheck = new Set(baseNames);
    if(uniqueCheck.size !== baseNames.length) {
        alert("Ci sono ancora nomi duplicati. Correggili prima di procedere.");
        return;
    }

    // Inizializza DB giocatori
    baseNames.forEach(n => {
      if (!playersDB.hasOwnProperty(n)) playersDB[n] = 0;
    });

    let attempts = 0;
    let validGeneration = false;
    let tempTeams = [];

    // Loop per trovare una combinazione diversa dalla precedente
    while (!validGeneration && attempts < 50) {
        let names = [...baseNames];
        
        // 1. Mischia (Fisher-Yates)
        for (let i = names.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [names[i], names[j]] = [names[j], names[i]];
        }

        tempTeams = [];
        const standardMatchSize = size * 2; 

        // 2. Crea partite STANDARD
        let namesPool = [...names]; 
        while (namesPool.length >= standardMatchSize) {
            const teamA = namesPool.splice(0, size);
            const teamB = namesPool.splice(0, size);
            tempTeams.push(teamA);
            tempTeams.push(teamB);
        }

        // 3. GESTIONE DEL RESTO
        const remainingCount = namesPool.length;

        if (remainingCount === 1) {
            if (tempTeams.length > 0) {
                tempTeams[tempTeams.length - 1].push(namesPool[0]);
            }
        } else if (remainingCount === 2) {
            tempTeams.push([namesPool[0]]);
            tempTeams.push([namesPool[1]]);
        } else if (remainingCount === 3) {
            tempTeams.push([namesPool[0], namesPool[1]]);
            tempTeams.push([namesPool[2]]);
        } else if (remainingCount === 4) {
            tempTeams.push([namesPool[0], namesPool[1]]);
            tempTeams.push([namesPool[2], namesPool[3]]);
        } else if (remainingCount > 4) {
            const half = Math.ceil(remainingCount / 2);
            tempTeams.push(namesPool.slice(0, half));
            tempTeams.push(namesPool.slice(half));
        }

        // 4. CREA "FIRMA" PER IL CONFRONTO
        const currentSignature = JSON.stringify(
            tempTeams.map(t => [...t].sort().join('|')).sort()
        );

        if (currentSignature !== previousTeamsSignature) {
            validGeneration = true;
            previousTeamsSignature = currentSignature;
            currentTeams = tempTeams;
        } else {
            attempts++;
        }
    }

    if (!validGeneration) {
        currentTeams = tempTeams;
    }

    renderMatchPreview();
    showStep(2);
  }

  function renderMatchPreview() {
    const container = document.getElementById('matchesList');
    container.innerHTML = '';
    
    for (let i = 0; i < currentTeams.length; i += 2) {
      const t1 = currentTeams[i];
      const t2 = currentTeams[i + 1];
      
      const div = document.createElement('div');
      div.className = 'match-card';
      
      if (t2) {
        div.innerHTML = `
          <div style="font-weight:bold; color:white;">${t1.join(' + ')}</div>
          <span class="vs-badge">VS</span>
          <div style="font-weight:bold; color:var(--danger);">${t2.join(' + ')}</div>
        `;
      } else {
        div.innerHTML = `
          <div style="color:#888;">${t1.join(' + ')}</div>
          <span class="vs-badge">RIPOSO / ATTESA</span>
        `;
      }
      container.appendChild(div);
    }
  }

  // --- STEP 2 -> 3: TIMER ---
  async function startMatch() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch (err) { console.log('Wake Lock non supportato'); }

    const mins = parseInt(document.getElementById('timeMin').value) || 0;
    const secs = parseInt(document.getElementById('timeSec').value) || 0;
    totalMatchMs = (mins * 60 + secs) * 1000;
    
    if (totalMatchMs <= 0) totalMatchMs = 300000;

    remainingMs = totalMatchMs;
    isPaused = false;
    isMatchRunning = true;
    resumeTimer(); 
    
    document.getElementById('whistleSound').play().catch(()=>{});
    document.getElementById('timerDisplay').classList.remove('pulse', 'timer-paused');
    
    const btnEnd = document.getElementById('btnEndMatch');
    btnEnd.innerText = "FISCHIO FINALE (CHIUDI ORA)";
    btnEnd.className = "btn-action btn-red";
    
    showStep(3);
  }

  function resumeTimer() {
    endTime = Date.now() + remainingMs;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        matchEnded();
      } else {
        renderTimer(diff);
        if (diff < 10000) document.getElementById('timerDisplay').classList.add('pulse');
      }
    }, 200);
  }

  function togglePause() {
    if (!isMatchRunning) return; 
    
    const btnLabel = document.getElementById('pauseBtnLabel');
    const display = document.getElementById('timerDisplay');

    if (!isPaused) {
      isPaused = true;
      clearInterval(timerInterval);
      remainingMs = endTime - Date.now();
      display.classList.add('timer-paused');
      btnLabel.innerText = "RIPRENDI ‚ñ∂";
    } else {
      isPaused = false;
      display.classList.remove('timer-paused');
      btnLabel.innerText = "PAUSA ||";
      resumeTimer();
    }
  }

  function renderTimer(ms) {
    const totalSeconds = Math.ceil(ms / 1000);
    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const s = (totalSeconds % 60).toString().padStart(2, '0');
    document.getElementById('timerDisplay').innerText = `${m}:${s}`;
  }

  function tryFinishMatch() {
    if (isMatchRunning) {
        if (confirm("Vuoi fischiare la fine della partita in anticipo?")) {
            matchEnded();
        }
    } else {
        finishMatchUI();
    }
  }

  function matchEnded() {
    clearInterval(timerInterval);
    isMatchRunning = false;
    
    document.getElementById('whistleSound').play().catch(()=>{});
    document.getElementById('timerDisplay').innerText = "00:00";
    document.getElementById('timerDisplay').classList.remove('pulse');
    
    const btnEnd = document.getElementById('btnEndMatch');
    btnEnd.innerText = "VAI AI RISULTATI >>";
    btnEnd.className = "btn-action"; 
    
    if (wakeLock) wakeLock.release();
    wakeLock = null;
  }

  function finishMatchUI() {
    buildScoreUI();
    showStep(4);
  }

  // --- STEP 3: CLASSIFICA LIVE (MODAL) ---
  function showLiveRanking() {
      const modal = document.getElementById('liveRankingModal');
      const tbody = document.querySelector('#liveRankingTable tbody');
      tbody.innerHTML = '';

      const sorted = Object.keys(playersDB)
          .map(key => ({ name: key, score: playersDB[key] }))
          .sort((a, b) => b.score - a.score);

      sorted.forEach((p, idx) => {
          const tr = document.createElement('tr');
          let medal = "";
          if (idx === 0) medal = "ü•á";
          if (idx === 1) medal = "ü•à";
          if (idx === 2) medal = "ü•â";
          tr.innerHTML = `
            <td style="color:#888">${idx + 1} ${medal}</td>
            <td style="color:white">${p.name}</td>
            <td style="text-align:right; font-weight:bold; color:var(--neon-green)">${p.score}</td>
          `;
          tbody.appendChild(tr);
      });

      modal.classList.add('active-modal');
  }

  function hideLiveRanking() {
      document.getElementById('liveRankingModal').classList.remove('active-modal');
  }

  // --- STEP 3 -> 4: UI PUNTEGGI ---
  function buildScoreUI() {
    const container = document.getElementById('scoringList');
    container.innerHTML = '';

    for (let i = 0; i < currentTeams.length; i += 2) {
      const t1 = currentTeams[i];
      const t2 = currentTeams[i + 1];
      
      if (!t2) continue;

      const row = document.createElement('div');
      row.className = 'score-row';
      const matchIndex = i/2;

      row.innerHTML = `
        <div class="team-btn" id="m${matchIndex}_t1" onclick="selectWinner(${matchIndex}, 1)">
          <div class="team-names">${t1.join('<br>')}</div>
          <div class="result-label" id="lbl_m${matchIndex}_t1">Perso (1pt)</div>
        </div>
        
        <div style="display:flex; align-items:center; font-weight:bold; color:#444;">VS</div>
        
        <div class="team-btn" id="m${matchIndex}_t2" onclick="selectWinner(${matchIndex}, 2)">
          <div class="team-names">${t2.join('<br>')}</div>
          <div class="result-label" id="lbl_m${matchIndex}_t2">Perso (1pt)</div>
        </div>
      `;
      container.appendChild(row);
    }
  }

  function selectWinner(matchIdx, teamNum) {
    const btn1 = document.getElementById(`m${matchIdx}_t1`);
    const btn2 = document.getElementById(`m${matchIdx}_t2`);
    const lbl1 = document.getElementById(`lbl_m${matchIdx}_t1`);
    const lbl2 = document.getElementById(`lbl_m${matchIdx}_t2`);

    if (teamNum === 1) {
      btn1.classList.toggle('selected');
    } else {
      btn2.classList.toggle('selected');
    }

    const t1Sel = btn1.classList.contains('selected');
    const t2Sel = btn2.classList.contains('selected');

    if (t1Sel && t2Sel) {
      lbl1.innerText = "PAREGGIO (2pt)"; lbl2.innerText = "PAREGGIO (2pt)";
      lbl1.style.color = "white"; lbl2.style.color = "white";
    } else if (t1Sel) {
      lbl1.innerText = "VITTORIA (3pt)"; lbl2.innerText = "SCONFITTA (1pt)";
      lbl1.style.color = "var(--neon-green)"; lbl2.style.color = "#666";
    } else if (t2Sel) {
      lbl1.innerText = "SCONFITTA (1pt)"; lbl2.innerText = "VITTORIA (3pt)";
      lbl1.style.color = "#666"; lbl2.style.color = "var(--neon-green)";
    } else {
      lbl1.innerText = "SELEZIONA ESITO"; lbl2.innerText = "SELEZIONA ESITO";
    }
  }

  // --- STEP 4 -> 5: SALVATAGGIO ---
  function saveScores() {
    const matchesCount = Math.floor(currentTeams.length / 2);
    
    for (let m = 0; m < matchesCount; m++) {
      const t1 = currentTeams[m * 2];
      const t2 = currentTeams[m * 2 + 1];
      
      const btn1 = document.getElementById(`m${m}_t1`);
      const btn2 = document.getElementById(`m${m}_t2`);
      
      const win1 = btn1.classList.contains('selected');
      const win2 = btn2.classList.contains('selected');

      let pts1 = 0, pts2 = 0;

      if (win1 && win2) { pts1 = 2; pts2 = 2; }
      else if (win1) { pts1 = 3; pts2 = 1; }
      else if (win2) { pts1 = 1; pts2 = 3; }
      else {
        alert("Attenzione: Seleziona un esito per tutte le partite!");
        return; 
      }

      t1.forEach(p => playersDB[p] += pts1);
      t2.forEach(p => playersDB[p] += pts2);
    }

    renderRanking();
    showStep(5);
  }

  // --- STEP 5: CLASSIFICA E MODIFICHE MANUALI ---
  function renderRanking() {
    const tbody = document.querySelector('#rankingTable tbody');
    tbody.innerHTML = '';
    
    const sortedPlayers = Object.keys(playersDB)
      .map(key => ({ name: key, score: playersDB[key] }))
      .sort((a, b) => b.score - a.score);

    sortedPlayers.forEach((p, index) => {
      const tr = document.createElement('tr');
      let medal = "";
      if (index === 0) medal = "ü•á";
      if (index === 1) medal = "ü•à";
      if (index === 2) medal = "ü•â";
      
      const safeName = p.name.replace(/'/g, "\\'"); 

      tr.innerHTML = `
        <td>${index + 1} ${medal}</td>
        <td>${p.name}</td>
        <td>
            <div class="manual-score-container">
                <button class="btn-adj minus" onclick="manualAdjust('${safeName}', -1)">-</button>
                <span style="font-weight:bold; min-width:30px; text-align:center;">${p.score}</span>
                <button class="btn-adj plus" onclick="manualAdjust('${safeName}', 1)">+</button>
            </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function manualAdjust(playerName, amount) {
    if(playersDB.hasOwnProperty(playerName)) {
        playersDB[playerName] += amount;
        renderRanking(); 
    }
  }

  function nextRound() {
    generateTeams();
  }

  function fullReset() {
    if(confirm("Reset totale? Canceller√† tutti i giocatori e punti.")) {
      playersDB = {};
      currentTeams = [];
      previousTeamsSignature = "";
      clearInterval(timerInterval);
      document.getElementById('playerInput').value = "";
      document.getElementById('playerCountVal').innerText = "0"; // Reset counter
      document.getElementById('duplicateAlert').style.display = "none";
      document.getElementById('btnGenerate').disabled = false;
      document.getElementById('btnGenerate').innerText = "CREA SQUADRE";
      showStep(1);
    }
  }
</script>

</body>
</html>
